const PriceData = require('../models/price-data')
const PriceProviderBase = require('./price-provider-base')

const baseApiUrl = 'https://apilayer.net/api'

const data = {
    "success":true,
    "terms":"https://currencylayer.com/terms",
    "privacy":"https://currencylayer.com/privacy",
    "timestamp":1740496212,
    "source":"USD",
    "quotes":{
        "USDAED":3.672785,
        "USDAFN":73.551196,
        "USDALL":94.213357,
        "USDAMD":393.550172,
        "USDANG":1.800818,
        "USDAOA":917.000329,
        "USDARS":1060.824597,
        "USDAUD":1.57943,
        "USDAWG":1.8025,
        "USDAZN":1.700885,
        "USDBAM":1.863101,
        "USDBBD":2.017538,
        "USDBDT":121.400912,
        "USDBGN":1.86345,
        "USDBHD":0.376895,
        "USDBIF":2959.385375,
        "USDBMD":1,
        "USDBND":1.337658,
        "USDBOB":6.904534,
        "USDBRL":5.775503,
        "USDBSD":0.999195,
        "USDBTC":1.1501769e-5,
        "USDBTN":87.087817,
        "USDBWP":13.763015,
        "USDBYN":3.270032,
        "USDBYR":19600,
        "USDBZD":2.007154,
        "USDCAD":1.42751,
        "USDCDF":2872.000044,
        "USDCHF":0.893245,
        "USDCLF":0.024588,
        "USDCLP":943.520228,
        "USDCNY":7.248098,
        "USDCNH":7.254385,
        "USDCOP":4120.05,
        "USDCRC":505.170303,
        "USDCUC":1,
        "USDCUP":26.5,
        "USDCVE":105.038795,
        "USDCZK":23.7105,
        "USDDJF":177.938452,
        "USDDKK":7.09935,
        "USDDOP":62.300844,
        "USDDZD":134.688045,
        "USDEGP":50.576584,
        "USDERN":15,
        "USDETB":125.829511,
        "USDEUR":0.951755,
        "USDFJD":2.297901,
        "USDFKP":0.791194,
        "USDGBP":0.78967,
        "USDGEL":2.814976,
        "USDGGP":0.791194,
        "USDGHS":15.503916,
        "USDGIP":0.791194,
        "USDGMD":72.320022,
        "USDGNF":8653.106649,
        "USDGTQ":7.71652,
        "USDGYD":209.360235,
        "USDHKD":7.77464,
        "USDHNL":25.598112,
        "USDHRK":7.174299,
        "USDHTG":131.397655,
        "USDHUF":383.120488,
        "USDIDR":16290.131559,
        "USDILS":3.57682,
        "USDIMP":0.791194,
        "USDINR":86.659806,
        "USDIQD":1309.464799,
        "USDIRR":42280.566776,
        "USDISK":138.541713,
        "USDJEP":0.791194,
        "USDJMD":157.631808,
        "USDJOD":0.708976,
        "USDJPY":148.988497,
        "USDKES":129.434949,
        "USDKGS":87.683228,
        "USDKHR":4005.89408,
        "USDKMF":469.523988,
        "USDKPW":899.984885,
        "USDKRW":1430.156307,
        "USDKWD":0.308597,
        "USDKYD":0.825768,
        "USDKZT":502.347813,
        "USDLAK":21707.340687,
        "USDLBP":89681.284684,
        "USDLKR":295.720859,
        "USDLRD":199.134569,
        "USDLSL":18.362817,
        "USDLTL":2.95274,
        "USDLVL":0.60489,
        "USDLYD":4.888947,
        "USDMAD":9.949214,
        "USDMDL":18.640103,
        "USDMGA":4724.669681,
        "USDMKD":58.788964,
        "USDMMK":2099.112905,
        "USDMNT":3465.409824,
        "USDMOP":8.007952,
        "USDMRU":40.090422,
        "USDMUR":46.337925,
        "USDMVR":15.441428,
        "USDMWK":1732.328056,
        "USDMXN":20.436645,
        "USDMYR":4.41153,
        "USDMZN":63.880149,
        "USDNAD":18.362817,
        "USDNGN":1501.408808,
        "USDNIO":36.752797,
        "USDNOK":11.103335,
        "USDNPR":138.720684,
        "USDNZD":1.748924,
        "USDOMR":0.385021,
        "USDPAB":1,
        "USDPEN":3.683046,
        "USDPGK":4.055139,
        "USDPHP":57.900158,
        "USDPKR":279.484218,
        "USDPLN":3.953702,
        "USDPYG":7895.794681,
        "USDQAR":3.639995,
        "USDRON":4.750347,
        "USDRSD":111.842628,
        "USDRUB":88.003926,
        "USDRWF":1403.887596,
        "USDSAR":3.749609,
        "USDSBD":8.533932,
        "USDSCR":14.561356,
        "USDSDG":600.790578,
        "USDSEK":10.60431,
        "USDSGD":1.338337,
        "USDSHP":0.794626,
        "USDSLE":22.940109,
        "USDSLL":20969.505638,
        "USDSOS":570.693501,
        "USDSRD":35.460307,
        "USDSTD":20697.981008,
        "USDSVC":8.749976,
        "USDSYP":13001.950046,
        "USDSZL":18.362817,
        "USDTHB":33.514563,
        "USDTJS":10.901525,
        "USDTMT":3.496319,
        "USDTND":3.166138,
        "USDTOP":2.405274,
        "USDTRY":36.45694,
        "USDTTD":6.792414,
        "USDTWD":32.720312,
        "USDTZS":2599.391065,
        "USDUAH":41.712108,
        "USDUGX":3675.697476,
        "USDUYU":42.864388,
        "USDUZS":12908.371659,
        "USDVES":63.3353,
        "USDVND":25502.662435,
        "USDVUV":121.998402,
        "USDWST":2.815878,
        "USDXAF":626.031984,
        "USDXAG":0.03137,
        "USDXAU":0.000341,
        "USDXCD":2.707138,
        "USDXDR":0.761556,
        "USDXOF":626.031984,
        "USDXPF":113.887781,
        "USDYER":247.455299,
        "USDZAR":18.37639,
        "USDZMK":9001.201776,
        "USDZMW":28.230956,
        "USDZWL":321.999592
    }
}

const base = 'USD'

class ApiLayerPriceProvider extends PriceProviderBase {
    constructor(apiKey, secret) {
        super(apiKey, secret)
    }

    name = 'apilayer'

    async __getTradeData(timestamp, timeout) {
        if (!this.apiKey) {
            throw new Error('API key is required for apilayer')
        }
        const klinesUrl = `${baseApiUrl}/live?access_key=${this.apiKey}&source=USD&format=1`
        const response = await this.__makeRequest(klinesUrl, {timeout})
        if (!response?.data?.success) {
            throw new Error('Failed to get data from apilayer')
        }
        return Object.keys(response.data.quotes).reduce((acc, symbol) => {
            const currentSymbol = symbol.substring(base.length)
            acc[currentSymbol] = new PriceData({
                price: response.data.quotes[symbol],
                source: this.name,
                ts: timestamp
            })
            acc[currentSymbol].price = PriceProviderBase.calcCrossPrice(acc[currentSymbol].price, 10000000n)
            return acc
        }, {})
    }
}

module.exports = ApiLayerPriceProvider